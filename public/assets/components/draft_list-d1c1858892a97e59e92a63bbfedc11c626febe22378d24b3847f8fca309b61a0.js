(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e=function(t,e){function r(){this.constructor=t}for(var i in e)n.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},n={}.hasOwnProperty;this.DraftList=function(n){function r(e){this.renderVersions=t(this.renderVersions,this),this.renderWebStatus=t(this.renderWebStatus,this),this.renderPrintStatus=t(this.renderPrintStatus,this),this.renderDiff=t(this.renderDiff,this),this.handleDraftMouseUp=t(this.handleDraftMouseUp,this),this.handleDraftMouseOver=t(this.handleDraftMouseOver,this),this.handleDraftMouseDown=t(this.handleDraftMouseDown,this),this.setVersions=t(this.setVersions,this),this.doUpdate=t(this.doUpdate,this),this.replaceDraft=t(this.replaceDraft,this),this.replaceDrafts=t(this.replaceDrafts,this),this.styles={mainContainer:{marginTop:"50px"},statusLabel:{display:"block",width:"100%"},actionButtons:{display:"block",width:"100%",marginBottom:"5px"},actionButtonsDimmed:{opacity:"0.2"},headline:{fontSize:"30px",lineHeight:"30px",marginBottom:"0",display:"inline-block"},briefTag:{display:"inline-block",marginLeft:"13px",transform:"translateY(-6px)"},subhead:{marginTop:"0",fontSize:"24px",color:"#888"},authors:{fontSize:"18px",color:"#888"},content:{marginTop:"20px",padding:"30px 40px",fontSize:"16px",lineHeight:"25px",backgroundColor:"#FFF"},contentP:{marginBottom:"20px"},metadata:{padding:"10px 40px"},changes:{normal:{color:"inherit"},added:{backgroundColor:"#DBFFDB",padding:"0"},removed:{backgroundColor:"#FFDDDD",padding:"0"}},sidebar:{padding:"10px 25px 20px"},sidebarHeader:{fontSize:"14px",fontWeight:"bold",color:"#888",textTransform:"uppercase",marginBottom:"5px",marginTop:"15px"},sidebarDescription:{textAlign:"right",fontSize:"10px",lineHeight:"12px",color:"#888",textTransform:"uppercase"},draftButton:{display:"block",width:"100%",marginBottom:"5px"},noChangeHint:{color:"#888",fontSize:"14px",textTransform:"uppercase",marginBottom:"20px",textAlign:"right",fontWeight:"bold"}},this.state={drafts:e.drafts,versionAId:e.drafts[e.drafts.length-1].id,versionBId:e.drafts[e.drafts.length-1].id}}return e(r,n),r.propTypes={article:React.PropTypes.object,drafts:React.PropTypes.array},r.prototype.replaceDrafts=function(t){return this.setState({drafts:t,versionAId:t[t.length-1].id,versionBId:t[t.length-1].id})},r.prototype.componentDidMount=function(){return MessageBus.subscribe("/updates",function(t){return function(e){if(console.log("MessageBus update: ",e),"article"===e.model&&e.id===t.props.article.id)return axios.get(Routes.article_drafts_path(e.id)).then(function(e){return e.data.error?alert(e.data.error):t.replaceDrafts(e.data.drafts)})["catch"](function(t){return logError(t),alert("Unknown error. Please refresh the page. ")})}}(this))},r.prototype.parseLines=function(t){var e,n;return e=function(t,e){var n;return n=_.clone(t),n.value=e,n},n=[[]],_.each(t,function(t){var r;return r=t.value.split("\n\n"),n[n.length-1].push(e(t,r[0])),_.each(_.rest(r),function(r){return n.push([e(t,r)])})}),n},r.prototype.replaceDraft=function(t){var e,n;if(e=this.state.drafts.slice(),n=_.findIndex(e,{id:t.id}),!(n<0))return e[n]=t,this.setState({drafts:e})},r.prototype.doUpdate=function(t,e){return axios.patch(Routes.article_draft_path(this.props.article.id,t.id),{draft:e}).then(function(t){return function(e){return null!=e.data.error?alert(e.data.error):(console.log(e.data),t.replaceDraft(e.data.draft))}}(this))["catch"](function(){return function(t){return alert("Unexpected error. Please refresh the page. "),logError(t)}}(this))},r.prototype.setVersions=function(t,e){var n,r,i;return n=_.findIndex(this.state.drafts,{id:t}),r=_.findIndex(this.state.drafts,{id:e}),n>r&&(i=[r,n],n=i[0],r=i[1]),this.setState({versionAId:this.state.drafts[n].id,versionBId:this.state.drafts[r].id,highlightAId:null,highlightBId:null})},r.prototype.handleDraftMouseDown=function(t){return this.pendingClick=t.id,this.setState({highlightAId:t.id,highlightBId:t.id})},r.prototype.handleDraftMouseOver=function(t){return this.setState({highlightBId:t.id})},r.prototype.handleDraftMouseUp=function(t){if(null!=this.pendingClick)return this.setVersions(this.pendingClick,t.id)},r.prototype.renderDiff=function(t,e,n,r){var i,o,a,s;return null==n&&(n={}),null==r&&(r=!1),s=JsDiff.diffWords(t,e,{newlineIsToken:!0}),i=this.parseLines(s),a=i.map(function(t){return function(e,r){return React.DOM.p({key:r,style:n},e.map(function(e,n){var r,i;return i=t.styles.changes.normal,e.added&&(i=t.styles.changes.added),e.removed&&(i=t.styles.changes.removed),r=e.value.replace(/\n/g,"<br/>"),React.createElement("span",{key:n,style:i,dangerouslySetInnerHTML:{__html:r}})}))}}(this)),o=a,!r||1!==s.length||s.removed||s.added||(o=[React.createElement("p",{key:-1,style:this.styles.noChangeHint},"There are no changes here. ")].concat(a)),React.DOM.div(null,o)},r.prototype.renderPrintStatus=function(t){return"print_ready"===t.print_status?React.createElement(StatusLabel,{style:this.styles.statusLabel,type:"success"},"Print: Ready"):React.createElement(StatusLabel,{style:this.styles.statusLabel,type:"danger"},"Print: Draft")},r.prototype.renderWebStatus=function(t){return"web_published"===t.web_status?React.createElement(StatusLabel,{style:this.styles.statusLabel,type:"success"},"Web: Published"):"web_ready"===t.web_status?React.createElement(StatusLabel,{style:this.styles.statusLabel,type:"info"},"Web: Ready"):React.createElement(StatusLabel,{style:this.styles.statusLabel,type:"danger"},"Web: Draft")},r.prototype.renderButton=function(t,e,n,r,i){return null==r&&(r=!0),null==i&&(i=null),r?React.createElement(Button,{style:this.styles.actionButtons,type:t,text:e,onClick:n,confirm:i}):null},r.prototype.renderLink=function(t,e,n,r,i){var o;return null==r&&(r=!0),null==i&&(i=null),r?(o=function(t){return window.open(n),t()},React.createElement(Button,{style:this.styles.actionButtons,type:t,text:e,onClick:o,confirm:i})):null},r.prototype.renderVersions=function(){var t,e,n;return null!=this.state.highlightAId?(t=_.findIndex(this.state.drafts,{id:this.state.highlightAId}),e=_.findIndex(this.state.drafts,{id:this.state.highlightBId}),console.log(t,e),t>e&&(n=[e,t],t=n[0],e=n[1])):(t=_.findIndex(this.state.drafts,{id:this.state.versionAId}),e=_.findIndex(this.state.drafts,{id:this.state.versionBId})),React.DOM.div(null,this.state.drafts.slice().reverse().map(function(n){return function(r){var i,o,a,s;return o=_.findIndex(n.state.drafts,{id:r.id}),"web_published"===r.web_status?(a="success",s="Published"):"web_ready"===r.web_status?(a="info",s="Ready"):(a="danger",s="Draft"),i=_.clone(n.styles.actionButtons),(o<t||e<o)&&_.extend(i,n.styles.actionButtonsDimmed),React.createElement("button",{className:"btn btn-sm btn-"+a,style:i,key:r.id,type:a,onMouseDown:this.handleDraftMouseDown.bind(this,r),onMouseOver:this.handleDraftMouseOver.bind(this,r),onMouseUp:this.handleDraftMouseUp.bind(this,r)},s+", "+$.timeago(r.created_at))}}(this),this))},r.prototype.render=function(){var t,e,n;return e=this.state.drafts[_.findIndex(this.state.drafts,{id:this.state.versionAId})],n=this.state.drafts[_.findIndex(this.state.drafts,{id:this.state.versionBId})],t=React.createElement("span",{className:"label label-default",style:this.styles.briefTag},"BRIEF"),React.createElement("div",{style:this.styles.mainContainer,className:"row"},React.createElement("article",{className:"col-sm-10"},React.createElement("div",{style:this.styles.metadata,className:"well"},React.createElement("h1",{style:this.styles.headline},this.renderDiff(e.headline,n.headline)),this.props.article.brief?t:null,React.createElement("h2",{style:this.styles.subhead},this.renderDiff(e.subhead,n.subhead)),React.createElement("div",{style:this.styles.authors},this.renderDiff("Authored by "+e.authors_string,"Authored by "+n.authors_string))),React.createElement("div",{style:this.styles.content,className:"well"},this.renderDiff(e.text,n.text,this.styles.contentP,e.id!=n.id))),React.createElement("div",{style:this.styles.sidebar,className:"col-sm-2 well"},React.createElement("p",{style:this.styles.sidebarHeader},"All Drafts"),React.createElement("p",{style:this.styles.sidebarDescription},"Click to show draft",React.createElement("br",null),"drag to show diff"),this.renderVersions(),React.createElement("p",{style:this.styles.sidebarHeader},"Draft Status"),this.renderWebStatus(n),this.renderPrintStatus(n),React.createElement("p",{style:this.styles.sidebarHeader},"Draft Actions"),this.renderButton("success","Mark Web Ready",this.doUpdate.bind(this,n,{web_status:"web_ready"}),"web_draft"==n.web_status&&this.props.article.can_ready),this.renderButton("success","Mark Print Ready",this.doUpdate.bind(this,n,{print_status:"print_ready"}),"print_draft"==n.print_status&&this.props.article.can_ready),this.renderLink("default","Edit",Routes.edit_article_path(this.props.article.id,{draft_id:n.id,format:"html"}),this.props.article.can_update)))},r}(React.Component)}).call(this);